#!/usr/bin/env python
import os
import subprocess
import sys
from enum import Enum


# *** Settings.

VERSION = "1.3.2"
COMPATIBILITY_MINIMUM = "4.5"


# *** Generate version header.

print("Generating SDK version header...")

git_sha = "unknown"
try:
    cmd = ["git", "rev-parse", "--short", "HEAD"]
    proc = subprocess.Popen(cmd, stdout=subprocess.PIPE)
    git_sha = proc.communicate()[0].strip().decode("utf-8")
except:
    pass

version_header_content = """/* DO NOT EDIT - generated by SConstruct */
#ifndef SENTRY_GODOT_SDK_VERSION_GEN_H
#define SENTRY_GODOT_SDK_VERSION_GEN_H

#define SENTRY_GODOT_SDK_VERSION \"{version}+{git_sha}\"

#endif // SENTRY_GODOT_SDK_VERSION_GEN_H
""".format(version=VERSION, git_sha=git_sha)

if not os.path.exists("src/gen/"):
    os.mkdir("src/gen/")
with open("src/gen/sdk_version.gen.h", "w") as f:
    f.write(version_header_content)


# *** Custom options system.

custom_options = {}
help_entries = []


def add_custom_bool_option(name, description, default=False):
    """Add a custom boolean option with help description."""
    value = ARGUMENTS.get(name, "no" if not default else "yes").lower() in ("yes", "true", "1")
    custom_options[name] = value
    help_entries.append({
        'name': name,
        'description': description,
        'default': default,
        'actual': value
    })


# Define our custom options
add_custom_bool_option("generate_ios_framework", "Generate iOS xcframework from static libraries", False)
add_custom_bool_option("build_android_lib", "Build Android bridge library", False)
add_custom_bool_option("separate_debug_symbols", "Separate debug symbols (supported on macOS, iOS, Linux, Android)", True)
add_custom_bool_option("generate_js_bundle", "Generate JavaScript bundle", False)

# Workaround: Remove custom options from ARGUMENTS to avoid warnings from godot-cpp.
# Godot complains about variables it does not recognize. See: https://github.com/godotengine/godot-cpp/issues/1334
original_arguments = dict(ARGUMENTS)
for key in custom_options.keys():
    if key in ARGUMENTS:
        del ARGUMENTS[key]


# *** Build godot-cpp.

print("Reading godot-cpp build configuration...")
env = SConscript("modules/godot-cpp/SConstruct")

platform = env["platform"]
arch = env["arch"]

# Register tools
env.Tool("copy")
env.Tool("plist")
env.Tool("separate_debug_symbols")

# Restore original ARGUMENTS and add custom options to environment
ARGUMENTS.clear()
ARGUMENTS.update(original_arguments)
for name, value in custom_options.items():
    env[name] = value

# Generate help for custom options
help_text = "\nCustom sentry-godot-cocoa options:\n"
for entry in help_entries:
    help_text += f"\n{entry['name']}: {entry['description']} (yes|no)\n"
    help_text += f"    default: {entry['default']}\n"
    help_text += f"    actual: {entry['actual']}\n"
Help(help_text)


# *** Select internal SDK and out_dir.

class SDK(Enum):
    DISABLED = 0
    NATIVE = 1
    ANDROID = 2
    COCOA = 3
    JAVASCRIPT = 4


if platform in ["linux", "windows"]:
    if arch in ["arm64", "arm32", "rv64"]:
        internal_sdk = SDK.DISABLED
    else:
        internal_sdk = SDK.NATIVE
elif platform in ["macos", "ios"]:
    internal_sdk = SDK.COCOA
elif platform == "android":
    internal_sdk = SDK.ANDROID
elif platform == "web":
    internal_sdk = SDK.JAVASCRIPT
else:
    internal_sdk = SDK.DISABLED

# Define output directory for the build target.
out_dir = f"project/addons/sentry/bin/{platform}"
if internal_sdk == SDK.DISABLED:
    out_dir = "project/addons/sentry/bin/noop"
elif internal_sdk == SDK.NATIVE:
    # Separate arch dirs to avoid crashpad handler filename conflicts.
    out_dir += "/" + arch
out_dir = Dir(out_dir)


# *** Build sentry-native.

if internal_sdk == SDK.NATIVE:
    env = SConscript("modules/sentry-native.SConscript", exports=["env"])

    # Deploy crashpad handler to project directory.
    deploy_crashpad_handler = env.CopyCrashpadHandler(out_dir)
    Default(deploy_crashpad_handler)

    if env["separate_debug_symbols"] and platform == "linux":
        handler_path = str(deploy_crashpad_handler[0])
        symbols_path = f"{handler_path}.debug"
        Default(env.SeparateDebugSymbols(File(symbols_path), File(handler_path)))


# *** Utilize sentry-cocoa.

if internal_sdk == SDK.COCOA:
    env = SConscript("modules/sentry-cocoa.SConscript", exports=["env"])

    # Deploy Sentry Cocoa dependency to project directory.
    deploy_cocoa = env.DeploySentryCocoa(out_dir)
    Default(deploy_cocoa)


# *** Build GDExtension library.

# Include relative to project source root.
env.Append(CPPPATH=["src/"])

# Source files to compile.
sources = Glob("src/*.cpp")
sources += Glob("src/editor/*.cpp")
sources += Glob("src/sentry/*.cpp")
sources += Glob("src/sentry/logging/*.cpp")
sources += Glob("src/sentry/processing/*.cpp")
sources += Glob("src/sentry/util/*.cpp")

# Backend-specific sources.
if internal_sdk == SDK.NATIVE:
    sources += Glob("src/sentry/native/*.cpp")
    env.Append(CPPDEFINES=["SDK_NATIVE"])
elif internal_sdk == SDK.ANDROID:
    sources += Glob("src/sentry/android/*.cpp")
    env.Append(CPPDEFINES=["SDK_ANDROID"])
    env.Append(LINKFLAGS="-Wl,--build-id=sha1")  # Add Build ID to binaries.
elif internal_sdk == SDK.COCOA:
    sources += Glob("src/sentry/cocoa/*.cpp")
    sources += Glob("src/sentry/cocoa/*.mm")
    env.Append(CPPDEFINES=["SDK_COCOA"])
elif internal_sdk == SDK.JAVASCRIPT:
    sources += Glob("src/sentry/javascript/*.cpp")
    env.Append(CPPDEFINES=["SDK_JAVASCRIPT"])

# Generate documentation data.
if env["target"] in ["editor", "template_debug"]:
    try:
        doc_data = env.GodotCPPDocData(
            "src/gen/doc_data.gen.cpp", source=Glob("doc_classes/*.xml"))
        sources.append(doc_data)
    except AttributeError:
        print("Not including class reference as we're targeting a pre-4.3 baseline.")

build_type = "release" if env["target"] == "template_release" else "debug"
shlib_suffix = env["SHLIBSUFFIX"]
extra = ""


if platform == "ios":
    # *** Build iOS shared library.

    if env["ios_simulator"]:
        extra += ".simulator"

    temp_dir = "project/addons/sentry/bin/ios/temp"
    lib_name = f"libsentry.{platform}.{build_type}.{arch}{extra}.dylib"
    lib_path = f"{temp_dir}/{lib_name}"

    library = env.SharedLibrary(lib_path, source=sources)
    Depends(library, deploy_cocoa)
    Default(library)

    # Generate XCFramework for iOS GDExtension libs if requested
    device_lib = f"{temp_dir}/libsentry.{platform}.{build_type}.arm64.dylib"
    simulator_lib = f"{temp_dir}/libsentry.{platform}.{build_type}.universal.simulator.dylib"
    xcframework_path = f"{out_dir}/libsentry.{platform}.{build_type}.xcframework"

    ios_framework = env.CreateXCFrameworkFromLibs(
        framework_path=xcframework_path,
        libraries=[device_lib, simulator_lib],
    )
    Alias("ios_framework", ios_framework)

    if env["generate_ios_framework"]:
        env.Depends(ios_framework, library)
        Default(ios_framework)

elif platform == "macos":
    # *** Build macOS shared library.

    lib_name = f"libsentry.{platform}.{build_type}{extra}.dylib"
    lib_path = f"{out_dir}/{lib_name}"

    library = env.SharedLibrary(lib_path, source=sources)
    Depends(library, deploy_cocoa)
    Default(library)

else:
    # *** Build shared library on other platforms.

    # Web builds come in two flavors: with threads and without.
    if env["threads"] is False:
        extra += ".nothreads"

    lib_name = f"libsentry.{platform}.{build_type}.{arch}{extra}{shlib_suffix}"
    lib_path = f"{out_dir}/{lib_name}"

    library = env.SharedLibrary(lib_path, source=sources)
    Default(library)


# *** Separate GDExtension debug symbols

if env["debug_symbols"] and env["separate_debug_symbols"]:
    # Note: Windows/MSVC separates by default.
    if platform in ["macos", "ios"]:
        dsym_path = f"{out_dir}/dSYMs/{lib_name}.dSYM"
        env.SeparateDebugSymbols(Dir(dsym_path), library)
    elif platform in ["linux", "android"]:
        symbols_path = f"{out_dir}/{lib_name}.debug"
        env.SeparateDebugSymbols(File(symbols_path), library)


# *** Build Android lib

if sys.platform.startswith("win"):
    gradle_cmd = "gradlew.bat assemble"
else:
    gradle_cmd = "./gradlew assemble"

# Use new environment importing current shell's env for greater compatibility.
env_gradle = Environment(ENV = os.environ)

android_lib = env_gradle.Command(
    target=[
        "project/addons/sentry/bin/android/sentry_android_godot_plugin.debug.aar",
        "project/addons/sentry/bin/android/sentry_android_godot_plugin.release.aar"
    ],
    source=[Dir("android_lib/")],
    action=[gradle_cmd]
)
env_gradle.NoCache(android_lib)
env_gradle.AlwaysBuild(android_lib)

Alias("android_lib", android_lib)

if env["build_android_lib"]:
    Default(android_lib)
    Depends(android_lib, library)

# *** Generate JavaScript bundle

js_bundle_cmd = "cd src/sentry/javascript/bridge && npm run build:deploy"
env_js_bundle = Environment(ENV = os.environ)

js_bundle = env_js_bundle.Command(
    target=[
        File("project/addons/sentry/web/sentry-bundle.js")
    ],
    source=[
        File("src/sentry/javascript/bridge/src/sentry-bridge.ts"),
        File("src/sentry/javascript/bridge/package.json"),
        File("src/sentry/javascript/bridge/package-lock.json"),
        File("src/sentry/javascript/bridge/tsconfig.json"),
        File("src/sentry/javascript/bridge/webpack.config.js"),
    ],
    action=[js_bundle_cmd]
)

Alias("js_bundle", js_bundle)

if env["generate_js_bundle"]:
    Default(js_bundle)
    Depends(js_bundle, library)

# *** Add help for optional targets.

Help("""
Optional targets:

ios_framework: Create iOS XCFramework from device and simulator builds.
               Usage: scons ios_framework
               Note: Requires both device and simulator builds to exist, and it
                     doesn't trigger a build.

android_lib: Build Android bridge library.
             Usage: scons android_lib

js_bundle: Generate JavaScript bundle.
           Usage: scons js_bundle
""")


# *** Deploy extension manifest.

manifest = env.Substfile(
    target="project/addons/sentry/sentry.gdextension",
    source="src/manifest.gdextension",
    SUBST_DICT={
        "{compatibility_minimum}": COMPATIBILITY_MINIMUM
    },
)

Default(manifest)


# *** Create symbolic link from project addons dir to gdUnit4 testing framework submodule.

def symlink(target, source, env):
    # Note: parameter `target` is a list of build targets.
    assert len(target) == 1
    assert len(source) == 1
    dst = str(target[0])
    src = str(source[0])
    if platform == "windows":
        # Create NTFS junction.
        # Note: Windows requires elevated privileges to create symlinks, so we're creating NTFS junction instead.
        try:
            import _winapi
            _winapi.CreateJunction(src, dst)
        except Exception as e:
            # Don't fail the build if this step fails.
            print("WARNING: Failed to create NTFS junction for gdUnit4: ", str(e))
    else:
        # Create symlink.
        src = os.path.relpath(src, os.path.dirname(dst))
        os.symlink(src, dst)
    return 0


gdunit_symlink = env.Command(
    "project/addons/gdUnit4",
    "modules/gdUnit4/addons/gdUnit4",
    [
        symlink,
    ],
)

Default(gdunit_symlink)

name: ðŸ§ª Integration tests

on:
  workflow_call:
    secrets:
      SENTRY_API_TOKEN:
        required: true
      SAUCE_USERNAME:
        required: true
      SAUCE_ACCESS_KEY:
        required: true
      FASTLANE_KEYCHAIN_PASSWORD:
        required: true
      MATCH_GIT_PRIVATE_KEY:
        required: true
      MATCH_PASSWORD:
        required: true

permissions:
  contents: read

jobs:
  integration-tests:
    name: Test ${{matrix.test-platform}} ${{matrix.godot-arch}}
    runs-on: ${{matrix.runner}}
    strategy:
      fail-fast: false
      matrix:
        include:
          - test-platform: Linux
            runner: ubuntu-latest
            godot-arch: x86_64

          - test-platform: Linux
            runner: ubuntu-latest
            godot-arch: x86_32

          - test-platform: Windows
            runner: windows-latest
            godot-arch: x86_64

          - test-platform: Windows
            runner: windows-latest
            godot-arch: x86_32

          - test-platform: macOS
            runner: macos-latest
            godot-arch: universal

          - test-platform: AndroidSauceLabs
            runner: ubuntu-latest
            godot-arch: x86_64
            test-executable: ./exports/android.apk
            export-platform: android
            saucelabs-device: Samsung_Galaxy.*

          - test-platform: iOSSauceLabs
            runner: macos-latest
            godot-arch: universal
            test-executable: ./exports/ios/ios.ipa
            export-platform: ios
            saucelabs-device: iPhone.*

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: false # don't initialize submodules automatically

      - name: Prepare testing
        uses: ./.github/actions/prepare-testing
        timeout-minutes: 15
        with:
          arch: ${{ matrix.godot-arch }}
          export-platform: ${{ matrix.export-platform }}

      - name: "Android: Export project"
        if: matrix.export-platform == 'android'
        timeout-minutes: 10
        shell: bash
        run: |
          "${GODOT}" --verbose --headless --disable-crash-handler --path project --install-android-build-template --export-debug "Android Tests" "${{github.workspace}}/${{matrix.test-executable}}" || true

      # Needed for fastlane
      - name: "iOS: Setup Ruby"
        if: matrix.export-platform == 'ios'
        uses: ruby/setup-ruby@90be1154f987f4dc0fe0dd0feedac9e473aa4ba8 # v1.286.0
        with:
          bundler-cache: true

      - name: "iOS: Import certificate and profile"
        if: matrix.export-platform == 'ios'
        env:
          FASTLANE_KEYCHAIN_PASSWORD: ${{ secrets.FASTLANE_KEYCHAIN_PASSWORD }}
          MATCH_GIT_PRIVATE_KEY: ${{ secrets.MATCH_GIT_PRIVATE_KEY }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        run: bundle exec fastlane prepare_signing

      - name: "iOS: Export project"
        if: matrix.export-platform == 'ios'
        timeout-minutes: 10
        shell: bash
        run: |
          mkdir -p "$(dirname "${{github.workspace}}/${{matrix.test-executable}}")"

          "${GODOT}" --verbose --headless --disable-crash-handler --path project --export-debug "iOS Tests" "${{github.workspace}}/${{matrix.test-executable}}" || true

          if [ ! -f "${{github.workspace}}/${{matrix.test-executable}}" ]; then
            echo "Error: Export failed - file does not exist: ${{github.workspace}}/${{matrix.test-executable}}"
            exit 1
          fi

      - name: Run integration tests
        shell: pwsh
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_API_TOKEN }}
          SENTRY_TEST_PLATFORM: ${{ matrix.test-platform }}
          SENTRY_TEST_EXECUTABLE: ${{ matrix.test-executable }}
          SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
          SAUCE_ACCESS_KEY: ${{ secrets.SAUCE_ACCESS_KEY }}
          SAUCE_REGION: us-west-1
          SAUCE_DEVICE_NAME: ${{ matrix.saucelabs-device }}
          SAUCE_SESSION_NAME: Godot ${{matrix.test-platform}} E2E Tests
        run: Invoke-Pester -Script integration_tests/Integration.Tests.ps1
